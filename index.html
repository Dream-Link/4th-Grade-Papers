<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4th Grade Paper</title>

    <!-- PWA Manifest Link -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0d6efd">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        :root {
            --primary-color: #0d6efd;
            --primary-dark: #0b5ed7;
            --primary-light: #cfe2ff;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #0dcaf0;
            
            --bg-color: #f8f9fa;
            --surface-color: #ffffff;
            --font-color: #212529;
            --font-color-light: #6c757d;
            --border-color: #dee2e6;
            
            --success-bg: #d1e7dd;
            --danger-bg: #f8d7da;
            --special-bg: #fff3cd;

            --font-family-primary: 'Noto Sans Devanagari', sans-serif;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --border-radius: 0.5rem;
        }

        * { box-sizing: border-box; }

        body {
            font-family: var(--font-family-primary);
            background-color: var(--bg-color);
            color: var(--font-color);
            margin: 0;
            line-height: 1.7;
        }
        
        #shift-selector-page {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem 1rem;
        }
        .selector-container {
            width: 100%;
            max-width: 800px;
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            padding: 2.5rem;
            text-align: center;
        }
        .selector-container h2 {
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        .selector-container .subtitle {
            font-size: 1rem;
            color: var(--font-color-light);
            margin-bottom: 2.5rem;
        }
        .shift-selector {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
        }
        .shift-btn {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background-color: #f8f9fa;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            text-decoration: none;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }
        .shift-btn:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary-color);
        }
        .shift-btn .icon {
            font-size: 1.5rem;
            color: var(--primary-color);
            width: 40px;
            height: 40px;
            display: grid;
            place-items: center;
            background-color: var(--primary-light);
            border-radius: 50%;
        }
        .shift-btn .text {
            font-weight: 600;
            color: var(--font-color);
        }
        .selector-footer {
            margin-top: 2rem;
            font-size: 0.875rem;
            color: var(--secondary-color);
        }

        #question-paper-page { display: none; flex-direction: column; }
        
        .top-sticky-bar {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: var(--surface-color);
            box-shadow: var(--shadow-sm);
            border-bottom: 1px solid var(--border-color);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .header h1 {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
            flex: 1 1 auto;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .header-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-shrink: 0;
        }
        .header-controls label { font-size: 0.875rem; font-weight: 500; }
        .header-controls select, .header-controls button {
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            border: 1px solid var(--border-color);
            background-color: #fff;
            font-family: inherit;
            font-size: 0.875rem;
        }
        #toggle-summary-btn {
            background-color: var(--primary-light);
            color: var(--primary-dark);
            border-color: var(--primary-light);
            font-weight: 600;
            cursor: pointer;
        }

        .summary-bar {
            padding: 1rem 1.5rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.75rem;
            border-top: 1px solid var(--border-color);
            background-color: #fdfdff;
            transition: all 0.3s ease;
        }
        .summary-bar.hidden { display: none; }
        .summary-item {
            text-align: center;
            padding: 0.5rem;
            border-radius: var(--border-radius);
        }
        .summary-item .count { font-size: 1.5rem; font-weight: 700; }
        .summary-item .label { font-size: 0.75rem; font-weight: 500; text-transform: uppercase; opacity: 0.8; }
        
        #total-item { background-color: #e9ecef; color: #343a40; }
        #attempted-item { background-color: var(--primary-light); color: var(--primary-dark); }
        #correct-item { background-color: var(--success-bg); color: var(--success-color); }
        #incorrect-item { background-color: var(--danger-bg); color: var(--danger-color); }
        #skipped-item { background-color: var(--special-bg); color: #856404; }
        #deleted-item { background-color: #e9ecef; color: #495057; }
        #right-que-item { background-color: #d1e7dd; color: #0f5132; }
        #raw-marks-item { background-color: #cfe2ff; color: #0a58ca; }
        
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1.5rem;
        }

        .controls-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .filter-buttons { display: flex; gap: 0.5rem; flex-wrap: wrap; }
        .filter-buttons button {
            background: none;
            border: 1px solid var(--border-color);
            border-radius: 2rem;
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            font-weight: 500;
        }
        .filter-buttons button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        #print-btn {
            background-color: var(--success-color);
            color: white;
            border: none;
            padding: 0.6rem 1.2rem;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s;
        }
        #print-btn:hover { background-color: #157347; }

        .question-block {
            background-color: var(--surface-color);
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            transition: box-shadow 0.2s ease;
        }
        .question-block:hover { box-shadow: var(--shadow-sm); }
        .question-info-bar {
            font-size: 0.8rem;
            color: var(--font-color-light);
            margin-bottom: 1rem;
        }
        .question-block h3 {
            margin: 0 0 1rem 0;
            font-size: 1.1rem;
            font-weight: 600;
        }
        .question-block img {
            max-width: 100%;
            height: auto;
            display: block;
            margin: 1rem auto;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .options-list {
            list-style: none;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .options-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }
        .options-grid li:last-child {
            grid-column: 1 / -1;
        }

        .options-list li {
            border: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }
        .options-list li:hover {
            border-color: var(--primary-color);
            background-color: #fcfdff;
        }
        .options-list li.correct, .options-list li.incorrect, .options-list li.special {
            color: var(--font-color);
            font-weight: 500;
        }
        .options-list li.correct {
            background-color: var(--success-bg);
            border-color: var(--success-color);
        }
        .options-list li.incorrect {
            background-color: var(--danger-bg);
            border-color: var(--danger-color);
        }
        .options-list li.special {
            background-color: var(--special-bg);
            border-color: var(--warning-color);
        }
        .correct-answer-display {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            font-weight: 600;
        }
        
        #print-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); z-index: 2000;
            display: none; align-items: center; justify-content: center;
        }
        #print-modal {
            background: white; padding: 2rem; border-radius: var(--border-radius);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            width: 90%; max-width: 400px;
        }
        #print-modal h2, #print-modal p, #print-modal label { margin: 0 0 1rem 0; }
        #print-modal input {
            width: 100%; padding: 0.75rem; border: 1px solid var(--border-color);
            border-radius: 0.375rem; font-size: 1rem; font-family: inherit;
        }
        .modal-buttons { display: flex; justify-content: flex-end; gap: 0.75rem; margin-top: 1.5rem; }
        .modal-buttons button {
            padding: 0.6rem 1.2rem; border-radius: 0.375rem; border: none;
            cursor: pointer; font-weight: 600; font-size: 0.9rem;
        }
        #cancel-print { background-color: #e9ecef; color: var(--font-color); }
        #confirm-print { background-color: var(--primary-color); color: white; }

        #print-fallback-details { display: none; }

        /* --- Responsive Design & Compact Mobile View --- */
        @media (max-width: 768px) {
            .selector-container { padding: 1.5rem; }
            .shift-selector { grid-template-columns: 1fr; }
            
            /* Compact Header: Title on top, controls below */
            .header {
                padding: 0.5rem 1rem;
                flex-wrap: wrap; /* Allow wrapping */
                justify-content: center; /* Center items */
                gap: 0.5rem;
            }
            .header h1 {
                width: 100%; /* Full width */
                text-align: center; /* Centered text */
                font-size: 1.1rem;
                margin-bottom: 0.25rem; /* Space below title */
                order: 1; /* Title first */
            }
            .header-controls {
                width: 100%; /* Full width */
                justify-content: center; /* Center controls */
                gap: 0.75rem;
                order: 2; /* Controls second */
            }
            .header-controls label { display: none; }
            .header-controls select, .header-controls button {
                 font-size: 0.8rem;
                 padding: 0.25rem 0.5rem;
            }

            .container { margin: 1rem auto; padding: 0 0.5rem; }

            /* Compact Controls Bar */
            .controls-bar {
                padding: 0.5rem;
                flex-wrap: nowrap;
                gap: 0.5rem;
            }
            .filter-buttons {
                gap: 0.25rem;
                justify-content: flex-start;
                overflow-x: auto; /* Allow horizontal scroll if needed */
                -ms-overflow-style: none;  /* IE and Edge */
                scrollbar-width: none;  /* Firefox */
            }
            .filter-buttons::-webkit-scrollbar { display: none; } /* Chrome, Safari */
            .filter-buttons button {
                padding: 0.3rem 0.7rem;
                font-size: 0.75rem;
                flex-shrink: 0;
            }
            #print-btn {
                padding: 0.3rem 0.7rem;
                font-size: 0.75rem;
            }

            /* Compact Summary Bar */
            .summary-bar {
                padding: 0.5rem;
                gap: 0.25rem;
            }
            .summary-item .count { font-size: 1.1rem; }
            .summary-item .label { font-size: 0.55rem; }
            
            .question-block { padding: 1rem; }
            .options-grid { grid-template-columns: 1fr; }
            .options-grid li:last-child { grid-column: auto; }
        }

        /* --- Printing Style Changes --- */
        @media print {
            body { font-size: 10pt; background-color: #fff !important; color: #000 !important; font-family: 'Noto Sans Devanagari', sans-serif; }
            .top-sticky-bar, .controls-bar, #print-modal-overlay, #shift-selector-page, .question-info-bar { display: none !important; }
            #question-paper-page, .container { display: block !important; margin: 0; padding: 0; box-shadow: none; border: none; }
            
            #print-fallback-details { 
                display: block !important;
                font-family: 'Noto Sans Devanagari', sans-serif;
                padding: 1cm;
            }
            #print-fallback-details h2 { 
                text-align: center; margin-top: 0; margin-bottom: 1rem; font-size: 1.5rem;
                border-bottom: 2px solid #333; padding-bottom: 0.5rem;
            }
            .print-info-grid {
                display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem 1.5rem;
                margin-bottom: 1rem; padding: 0.75rem;
                border: 1px solid #ccc; border-radius: 8px;
            }
            .print-info-grid p { margin: 2px 0; font-size: 1rem; }
            .print-paper-code strong, .print-paper-code span { color: red !important; font-weight: bold !important; }

            .print-summary-table {
                width: 100%; border-collapse: collapse; text-align: center; margin-bottom: 1.5rem;
            }
            .print-summary-table th, .print-summary-table td {
                border: 1px solid #999; padding: 5px; font-size: 0.9rem;
            }
            .print-summary-table th { background-color: #f2f2f2; font-weight: bold; }
            #print-correct { color: var(--success-color) !important; font-weight: bold; }
            #print-incorrect { color: var(--danger-color) !important; font-weight: bold; }
            #print-raw-marks-display, #print-final-rq-display { font-weight: bold; }

            /* Better alignment for question block */
            .question-block { 
                page-break-inside: avoid;
                padding: 0.4rem 8px; /* Added horizontal padding */
                margin-bottom: 0.5rem !important;
                border-bottom: 1px dashed #aaa !important;
            }
            .question-block:last-of-type { border-bottom: none !important; }

            .question-block h3 {
                font-size: 10.5pt;
                margin: 0 0 0.4rem 0;
                font-weight: normal;
            }
            .question-block h3 .print-q-num {
                font-weight: bold;
            }

            .question-block img { max-width: 60% !important; page-break-inside: avoid; margin: 0.5rem auto; }
            
            .options-list { margin-top: 0.3rem; gap: 3px; }
            .options-list li {
                padding: 4px 8px;
                font-size: 10pt;
            }
            .correct-answer-display {
                font-size: 9pt;
                margin-top: 0.4rem;
                padding-top: 0.4rem;
                border-top: 1px solid #ddd;
            }
            .options-grid { grid-template-columns: 1fr 1fr; }

            .options-list li.correct, .options-list li.incorrect, .options-list li.special {
                -webkit-print-color-adjust: exact !important; color-adjust: exact !important;
            }
            .options-list li.correct { background-color: var(--success-bg) !important; border-color: #b3d9c5 !important; }
            .options-list li.incorrect { background-color: var(--danger-bg) !important; border-color: #f1b0b7 !important; }
            .options-list li.special { background-color: var(--special-bg) !important; border-color: #ffeeba !important; }
        }
    </style>
    
    <script>
        MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] } };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>
<body>
    
    <div id="print-fallback-details">
        <h2 id="print-title"></h2>
        <div class="print-info-grid">
            <p><strong>नाम:</strong> <span id="print-name"></span></p>
            <p class="print-paper-code"><strong>पेपर कोड:</strong> <span id="print-series"></span></p>
            <p><strong>रोल नंबर:</strong> <span id="print-roll"></span></p>
            <p><strong>RAW Marks:</strong> <span id="print-raw-marks-display"></span></p>
        </div>
        <table class="print-summary-table">
            <thead>
                <tr>
                    <th>कुल प्रश्न</th> <th>वैध प्रश्न</th> <th>हल किए</th> <th>सही</th> <th>गलत</th> <th>छोड़े (E)</th> <th>Delete</th> <th>अंतिम सही प्रश्न</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><span id="print-full-total"></span></td>
                    <td><span id="print-valid-total"></span></td>
                    <td><span id="print-attempted"></span></td>
                    <td id="print-correct"></td>
                    <td id="print-incorrect"></td>
                    <td><span id="print-skipped"></span></td>
                    <td><span id="print-deleted"></span></td>
                    <td id="print-final-rq-display"></td>
                </tr>
            </tbody>
        </table>
    </div>

    <div id="shift-selector-page">
        <div class="selector-container">
            <h2>4th Class Paper 2025</h2>
            <p class="subtitle">कृपया मूल्यांकन के लिए अपनी शिफ़्ट चुनें।</p>
            <div class="shift-selector">
                <a class="shift-btn" data-shift="shift1"><div class="icon"><i class="fas fa-file-alt"></i></div><div class="text">1st Shift 19.09.2025</div></a>
                <a class="shift-btn" data-shift="shift2"><div class="icon"><i class="fas fa-file-alt"></i></div><div class="text">2nd Shift 19.09.2025</div></a>
                <a class="shift-btn" data-shift="shift3"><div class="icon"><i class="fas fa-file-alt"></i></div><div class="text">3rd Shift 20.09.2025</div></a>
                <a class="shift-btn" data-shift="shift4"><div class="icon"><i class="fas fa-file-alt"></i></div><div class="text">4th Shift 20.09.2025</div></a>
                <a class="shift-btn" data-shift="shift5"><div class="icon"><i class="fas fa-file-alt"></i></div><div class="text">5th Shift 21.09.2025</div></a>
                <a class="shift-btn" data-shift="shift6"><div class="icon"><i class="fas fa-file-alt"></i></div><div class="text">6th Shift 21.09.2025</div></a>
            </div>
            <div class="selector-footer">
                <p>Last Update: 24/09/2025 02:30 PM</p>
                <p>सभी प्रश्नों के उत्तर संभावित उत्तर कुंजी के आधार पर हैं, आधिकारिक कुंजी जारी होने पर UPDATE कर दी जाएगी।</p>
                <p><strong>- MP Salodiya</strong></p>
            </div>
        </div>
    </div>

    <div id="question-paper-page">
        <div class="top-sticky-bar">
            <div class="header">
                 <h1 id="shift-title">Shift Title</h1>
                <div class="header-controls">
                    <label for="series-select">Paper Code:</label>
                    <select id="series-select"></select>
                    <button id="toggle-summary-btn">Show Result</button>
                </div>
            </div>
            <div class="summary-bar hidden">
                <div id="total-item" class="summary-item"><div id="total-count" class="count">0</div><div class="label">Valid Que.</div></div>
                <div id="attempted-item" class="summary-item"><div id="attempted-count" class="count">0</div><div class="label">Attempt</div></div>
                <div id="correct-item" class="summary-item"><div id="correct-count" class="count">0</div><div class="label">Right</div></div>
                <div id="incorrect-item" class="summary-item"><div id="incorrect-count" class="count">0</div><div class="label">Wrong</div></div>
                <div id="skipped-item" class="summary-item"><div id="skipped-count" class="count">0</div><div class="label">Skip (E)</div></div>
                <div id="deleted-item" class="summary-item"><div id="deleted-count" class="count">0</div><div class="label">Deleted</div></div>
                <div id="right-que-item" class="summary-item"><div id="right-que-value" class="count">0.00</div><div class="label">Final R.Q.</div></div>
                <div id="raw-marks-item" class="summary-item"><div id="raw-marks-value" class="count">0.00</div><div class="label">RAW Marks</div></div>
            </div>
        </div>
        <div class="container">
            <div class="controls-bar">
                <div class="filter-buttons">
                    <button class="active" data-filter="all">All</button>
                    <button data-filter="correct">Right</button>
                    <button data-filter="incorrect">Wrong</button>
                    <button data-filter="skipped">Skip (E)</button>
                    <button data-filter="deleted">Deleted</button>
                </div>
                <button id="print-btn"><i class="fas fa-print"></i> Print</button>
            </div>
            <div id="questions-container"></div>
        </div>
    </div>

    <div id="print-modal-overlay">
        <div id="print-modal">
            <h2>Print Details</h2>
            <p>कृपया प्रिंट करने से पहले अपना नाम और रोल नंबर दर्ज करें।</p>
            <label for="student-name">Name:</label>
            <input type="text" id="student-name" placeholder="Your Name">
            <label for="student-roll">Roll No.:</label>
            <input type="text" id="student-roll" placeholder="Your Roll No.">
            <div class="modal-buttons">
                <button id="cancel-print">Cancel</button>
                <button id="confirm-print">Confirm & Print</button>
            </div>
        </div>
    </div>
    
    <script src="questions-data.js"></script>
    <script>
        let currentShiftId = null, allQuestions = [], userAnswers = {}, currentSeries = '', activeFilter = 'all', currentShiftData = {};

        document.addEventListener('DOMContentLoaded', () => {
            
            if (typeof allShiftData === 'undefined') {
                document.body.innerHTML = '<h1 style="text-align:center; padding: 2rem; color: red;">Error: Question data (questions-data.js) could not be loaded. Please check the file.</h1>';
                return;
            }

            const shiftSelectorPage = document.getElementById('shift-selector-page');
            const questionPaperPage = document.getElementById('question-paper-page');
            const seriesSelect = document.getElementById('series-select');
            const printBtn = document.getElementById('print-btn');
            const pMO = document.getElementById('print-modal-overlay');

            function showHomePage() {
                shiftSelectorPage.style.display = 'flex';
                questionPaperPage.style.display = 'none';
                currentShiftId = null;
                history.pushState({page: 'home'}, 'Home', window.location.pathname);
                window.location.hash = '';
            }

            window.addEventListener('popstate', (event) => {
                if (!event.state || event.state.page === 'home') {
                    showHomePage();
                } else if (event.state.shift) {
                    loadShift(event.state.shift, false);
                }
            });

            document.querySelectorAll('.shift-btn').forEach(b => b.addEventListener('click', () => loadShift(b.dataset.shift, true)));

            function loadShift(shiftId, shouldPushState = true) {
                shiftSelectorPage.style.display = 'none';
                questionPaperPage.style.display = 'flex';
                currentShiftId = shiftId;
                currentShiftData = allShiftData[shiftId];
                allQuestions = currentShiftData.questions;
                
                document.getElementById('shift-title').textContent = currentShiftData.title;

                seriesSelect.innerHTML = '';
                const availableSeries = Object.keys(currentShiftData.seriesOrder || {});
                if (availableSeries.length > 0) {
                    availableSeries.forEach(seriesKey => {
                        const option = document.createElement('option');
                        option.value = seriesKey;
                        option.textContent = seriesKey;
                        seriesSelect.appendChild(option);
                    });
                }

                userAnswers = JSON.parse(localStorage.getItem(`userAnswers_${shiftId}`)) || {};
                
                const savedSeries = localStorage.getItem(`currentSeries_${shiftId}`);
                currentSeries = (savedSeries && availableSeries.includes(savedSeries)) ? savedSeries : availableSeries[0] || '';
                seriesSelect.value = currentSeries;

                activeFilter = 'all';
                document.getElementById('toggle-summary-btn').textContent = 'Show Result';
                document.querySelector('.summary-bar').classList.add('hidden');
                
                if (shouldPushState) {
                   history.pushState({ shift: shiftId }, '', `#${shiftId}`);
                }
                displayQuestions(currentSeries, activeFilter);
            }

            function saveData() {
                if (!currentShiftId) return;
                localStorage.setItem(`userAnswers_${currentShiftId}`, JSON.stringify(userAnswers));
                localStorage.setItem(`currentSeries_${currentShiftId}`, currentSeries);
            }

            function getQuestionStatus(qId) {
                const uAnsText = userAnswers[qId];
                if (!uAnsText) return 'unattempted';
                if (uAnsText === "अनुत्तरित प्रश्न" || uAnsText === "Question not attempted") return 'skipped';
                const qData = allQuestions.find(q => q.id === qId);
                const correctAnswerText = qData.answer.substring(3);
                return uAnsText === correctAnswerText ? 'correct' : 'incorrect';
            }

            function updateSummary() {
                let c = 0, i = 0, s = 0, d = 0;
                allQuestions.forEach(q => {
                    if (q.deleted) { d++; return; }
                    const st = getQuestionStatus(q.id);
                    if (st === 'correct') c++;
                    else if (st === 'incorrect') i++;
                    else if (st === 'skipped') s++;
                });
                
                const a = c + i; 
                const totalValidQuestions = allQuestions.length - d;
                
                document.getElementById('total-count').textContent = totalValidQuestions;
                document.getElementById('attempted-count').textContent = a;
                document.getElementById('correct-count').textContent = c;
                document.getElementById('incorrect-count').textContent = i;
                document.getElementById('skipped-count').textContent = s;
                document.getElementById('deleted-count').textContent = d;
                
                const rQ = c - (i / 3);
                let rM = (totalValidQuestions > 0) ? rQ * (200 / totalValidQuestions) : 0;
                
                document.getElementById('right-que-value').textContent = (rQ % 1 === 0) ? rQ : rQ.toFixed(2);
                document.getElementById('raw-marks-value').textContent = rM.toFixed(2);
            }
            
            function findQuestionPositions(qId) {
                const qIndex = allQuestions.findIndex(q => q.id === qId);
                if (qIndex === -1 || !currentShiftData.seriesOrder) return `Q ID: ${qId}`;

                const positions = [];
                for (const series in currentShiftData.seriesOrder) {
                    const pos = currentShiftData.seriesOrder[series].indexOf(qIndex + 1);
                    if (pos !== -1) {
                        positions.push(`<strong>${series}:</strong> #${pos + 1}`);
                    }
                }
                return positions.length > 0 ? positions.join(' | ') : `Q ID: ${qId}`;
            }

            function displayQuestions(series, filter = 'all') {
                const qC = document.getElementById('questions-container');
                qC.innerHTML = '';
                currentSeries = series;
                updateSummary();
                updateActiveFilterButton(filter);

                const seriesOrder = currentShiftData.seriesOrder || {};
                const qIndices = seriesOrder[series] || Array.from({length: allQuestions.length}, (_, i) => i + 1);
                
                const optionLabels = ['A)', 'B)', 'C)', 'D)', 'E)'];
                const OPTION_LENGTH_THRESHOLD = 40; 

                qIndices.forEach((qIndex, displayNum) => {
                    const qData = allQuestions[qIndex - 1];
                    if (!qData) return;

                    const isDeleted = qData.deleted === true;
                    const status = isDeleted ? 'deleted' : getQuestionStatus(qData.id);

                    if (filter !== 'all' && filter !== status) return;
                    
                    const qB = document.createElement('div');
                    qB.className = 'question-block';
                    qB.dataset.questionId = qData.id;
                    
                    const iB = document.createElement('div');
                    iB.className = 'question-info-bar';
                    iB.innerHTML = findQuestionPositions(qData.id);
                    qB.appendChild(iB);

                    const qT = document.createElement('h3');
                    qT.innerHTML = `<span class="print-q-num">प्रश्न ${displayNum + 1}: </span> ${qData.question}`;
                    qB.appendChild(qT);
                    
                    if (qData.image) {
                        const qImg = document.createElement('img');
                        qImg.src = qData.image;
                        qImg.alt = "प्रश्न चित्र";
                        qB.appendChild(qImg);
                    }
                    
                    const oL = document.createElement('ul');
                    oL.className = 'options-list';

                    const optionsAreShort = qData.options.slice(0, 4).every(opt => opt.length < OPTION_LENGTH_THRESHOLD);
                    if (optionsAreShort && qData.options.length === 5) {
                        oL.classList.add('options-grid');
                    }
                    
                    const optionTexts = qData.options.map(opt => opt.substring(3));
                    let shuffledOptionTexts;
                    const optionOrder = currentShiftData.seriesOptionOrder?.[series];

                    if (optionOrder) {
                        shuffledOptionTexts = optionOrder.map(index => optionTexts[index]);
                    } else {
                        shuffledOptionTexts = [...optionTexts];
                    }
                    const finalOptions = shuffledOptionTexts.map((text, index) => `${optionLabels[index]} ${text}`);

                    finalOptions.forEach(oT => {
                        const oI = document.createElement('li');
                        oI.innerHTML = oT;
                        oI.dataset.rawText = oT.substring(3).trim();
                        const userAnswerText = userAnswers[qData.id];
                        if (userAnswerText && userAnswerText === oI.dataset.rawText) {
                            if (status === 'correct') oI.classList.add('correct');
                            else if (status === 'incorrect') oI.classList.add('incorrect');
                            else if (status === 'skipped') oI.classList.add('special');
                        }
                        oL.appendChild(oI);
                    });
                    qB.appendChild(oL);

                    if (isDeleted) {
                        const deletedAnsDisplay = document.createElement('div');
                        deletedAnsDisplay.className = 'correct-answer-display';
                        deletedAnsDisplay.innerHTML = 'Status: <strong style="color: var(--danger-color);">Deleted</strong>';
                        qB.appendChild(deletedAnsDisplay);
                    }
                    else if (status !== 'unattempted') {
                        const aD = document.createElement('div');
                        aD.className = 'correct-answer-display';
                        const correctAnswerText = qData.answer.substring(3);
                        const newCorrectIndex = shuffledOptionTexts.indexOf(correctAnswerText);
                        let dynamicCorrectAnswer = qData.answer;
                        if (newCorrectIndex !== -1) {
                            dynamicCorrectAnswer = `${optionLabels[newCorrectIndex]} ${correctAnswerText}`;
                        }
                        aD.innerHTML = `Correct Ans: <strong style="color: var(--success-color);">${dynamicCorrectAnswer}</strong>`;
                        qB.appendChild(aD);
                    }

                    qC.appendChild(qB);
                    
                    oL.addEventListener('click', (e) => {
                        const clickedLi = e.target.closest('li');
                        if (clickedLi && !isDeleted) {
                            userAnswers[qData.id] = clickedLi.dataset.rawText;
                            saveData();
                            displayQuestions(currentSeries, activeFilter);
                        }
                    });
                });

                if (qC.innerHTML === '') {
                    qC.innerHTML = `<p style="text-align:center; color: var(--font-color-light); padding: 2rem;">इस फ़िल्टर में कोई प्रश्न नहीं है।</p>`;
                }
                if (window.MathJax) { MathJax.typesetPromise(); }
            }
               
            function updateActiveFilterButton(filter) {
                document.querySelectorAll('.filter-buttons button').forEach(btn => btn.classList.remove('active'));
                document.querySelector(`.filter-buttons button[data-filter="${filter}"]`).classList.add('active');
            }

            seriesSelect.addEventListener('change', (e) => {
                displayQuestions(e.target.value, activeFilter);
                saveData();
            });

            document.querySelectorAll('.filter-buttons button').forEach(b => b.addEventListener('click', () => {
                activeFilter = b.dataset.filter;
                displayQuestions(currentSeries, activeFilter);
            }));

            document.getElementById('toggle-summary-btn').addEventListener('click', (e) => {
                const sB = document.querySelector('.summary-bar');
                sB.classList.toggle('hidden');
                e.target.textContent = sB.classList.contains('hidden') ? 'Show Result' : 'Hide Result';
            });

            function triggerPrint(name, rollNo) {
                document.getElementById('print-title').textContent = document.getElementById('shift-title').textContent;
                document.getElementById('print-name').textContent = name;
                document.getElementById('print-roll').textContent = rollNo;
                document.getElementById('print-series').textContent = seriesSelect.value;
                
                document.getElementById('print-full-total').textContent = allQuestions.length;
                document.getElementById('print-valid-total').textContent = document.getElementById('total-count').textContent;

                document.getElementById('print-attempted').textContent = document.getElementById('attempted-count').textContent;
                document.getElementById('print-correct').textContent = document.getElementById('correct-count').textContent;
                document.getElementById('print-incorrect').textContent = document.getElementById('incorrect-count').textContent;
                document.getElementById('print-skipped').textContent = document.getElementById('skipped-count').textContent;
                document.getElementById('print-deleted').textContent = document.getElementById('deleted-count').textContent;
                
                document.getElementById('print-final-rq-display').textContent = document.getElementById('right-que-value').textContent;
                document.getElementById('print-raw-marks-display').textContent = document.getElementById('raw-marks-value').textContent;

                setTimeout(() => { window.print(); }, 250);
            }

            printBtn.addEventListener('click', () => { pMO.style.display = 'flex'; });
            document.getElementById('cancel-print').addEventListener('click', () => { pMO.style.display = 'none'; });
            document.getElementById('confirm-print').addEventListener('click', () => {
                const name = document.getElementById('student-name').value;
                const rollNo = document.getElementById('student-roll').value;
                if (!name || !rollNo) { alert("नाम और रोल नंबर दोनों आवश्यक हैं।"); return; }
                pMO.style.display = 'none';
                triggerPrint(name, rollNo);
            });

            const shiftIdFromUrl = window.location.hash.substring(1);
            if (shiftIdFromUrl && allShiftData[shiftIdFromUrl]) {
                loadShift(shiftIdFromUrl);
            } else {
                showHomePage();
            }
        });

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed: ', error);
                    });
            });
        }
    </script>
</body>
</html>

